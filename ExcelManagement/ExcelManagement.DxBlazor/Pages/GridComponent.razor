@using System.Dynamic
@using DevExpress.Data
@using ClosedXML.Excel
@using ClassLibary.Models
@using ClassLibary

<DxGrid @ref="Grid"
        Data="@SheetData.Value"
        PageSize="10"
        PagerPosition="GridPagerPosition.TopAndBottom"
        PageSizeSelectorVisible="true"
        PageSizeSelectorItems="@(new int[] {5, 10, 20, 50, 100})"
        PageSizeSelectorAllRowsItemVisible="true"
        PagerSwitchToInputBoxButtonCount="10"
        PagerVisibleNumericButtonCount="10"
        EditMode="GridEditMode.PopupEditForm"
        PopupEditFormCssClass="pw-800"
        PopupEditFormHeaderText="Edit Row"
        ValidationEnabled="false"
        KeyFieldName="GridId"
        EditModelSaving="@((args) => Grid_EditModelSaving(args, SheetData.Key))"
        DataItemDeleting="@((args) => Grid_DataItemDeleting(args, SheetData.Key))"
        CustomizeEditModel="@((args) => Grid_CustomizeEditModel(args, SheetData.Key))">

    <Columns>
        <DxGridCommandColumn Width="160px" />
        @foreach (var property in ((IDictionary<string, object>)SheetData.Value[0]).Keys.Skip(1))
        {
            <DxGridDataColumn FieldName="@property" MinWidth="100" />
        }
    </Columns>
    <EditFormTemplate Context="EditFormContext">
        <DxFormLayout CssClass="w-100">
            @foreach (var property in ((IDictionary<string, object>)SheetData.Value[0]).Keys.Skip(1))
            {
                var dataItem = (IDictionary<string, object>)EditFormContext.EditModel;
                var cellValue = ((XlCellView)dataItem[property]).Value;

                @*If Cell Has formula*@
                bool readOnly = false;
                if (((XlCellView)dataItem[property]).XlCell.HasFormula)
                {
                    readOnly = true;
                }

                <DxFormLayoutItem Caption = "@(property + ":")" ColSpanMd = "6">

                    @*If Value Text*@
                    @if (((XlCellView)dataItem[property]).Type == XLDataType.Text)
                    {
                        var value = (string)cellValue;
                        <DxTextBox Text="@value"
                            TextChanged="@((string newVal) => ((XlCellView)dataItem[property]).Value = newVal)"
                            TextExpression="@(() => value)"
                            ReadOnly="readOnly">
                        </DxTextBox>
                    }

                    @*If Value Blank*@
                    else if (((XlCellView)dataItem[property]).Type == XLDataType.Blank)
                    {
                        var value = (string)cellValue;
                        <DxTextBox Text="@value"
                            TextChanged="@((string newVal) => ((XlCellView)dataItem[property]).Value = newVal)"
                            TextExpression="@(() => value)"
                            ReadOnly="readOnly">
                        </DxTextBox>
                    }

                    @*If Value Datetime*@
                    else if (((XlCellView)dataItem[property]).Type == XLDataType.DateTime)
                    {
                        var value = (DateTime)cellValue;
                        <DxDateEdit Date="@value"
                            DateChanged="@((DateTime newVal) => ((XlCellView)dataItem[property]).Value = newVal)"
                            DateExpression="@(() => value)"
                            ReadOnly="readOnly">
                        </DxDateEdit>
                    }

                    @*If Value Number*@
                    else if (((XlCellView)dataItem[property]).Type == XLDataType.Number)
                    {
                        var value = (double)cellValue;
                        <DxSpinEdit Text="@value"
                            ValueChanged="@((double newVal) => ((XlCellView)dataItem[property]).Value = newVal)"
                           ValueExpression="@(() => value)"
                           ReadOnly="readOnly">
                        </DxSpinEdit>
                    }


                </DxFormLayoutItem>
                
            }
        </DxFormLayout>
    </EditFormTemplate>

</DxGrid>


@code {
    [Parameter] public IGrid? Grid { get; set; }
    [Parameter] public string SelectedFile { get; set; }
    [Parameter] public KeyValuePair<string, List<dynamic>> SheetData { get; set; }
    [Parameter] public EventCallback UpdateData { get; set; }
    ExcelRepository excelRepository;

    protected async Task OnInitializedAsync()
    {
        
    }

    //---------------------------------------------------------------------------//
    /* CRUD Operations - Repository Interactions                                 */
    //---------------------------------------------------------------------------//

    //Edit Model
    private async Task Grid_CustomizeEditModel(GridCustomizeEditModelEventArgs e, string sheetName)
    {
        if (e.IsNew)
        {
            var model = new ExpandoObject() as IDictionary<string, object>;
            var dataItem = (IDictionary<string, object>)e.Grid.GetDataItem(0);
            var properties = dataItem.Keys.ToArray();
            //var originalValues = dataItem.Values.ToArray();
            for (var i = 0; i < properties.Length; i++)
            {
                if (properties[i] != "ID")
                    model[properties[i]] = string.Empty;
            }
            e.EditModel = model;
        }
    }

    //Save Row
    private async Task Grid_EditModelSaving(GridEditModelSavingEventArgs e, string sheetName)
    {
        var updatedDataItem = e.EditModel;
        var originalDataItem = e.DataItem;

        excelRepository = new ExcelRepository();
        excelRepository.UpdateRowInExcel(sheetName, updatedDataItem);

        //int index = data[sheetName].IndexOf(originalDataItem);
        //data[sheetName][index] = updatedDataItem;

        await UpdateData.InvokeAsync();
    }

    //Delete Row
    private async Task Grid_DataItemDeleting(GridDataItemDeletingEventArgs e, string sheetName)
    {
        var deletedDataItem = e.DataItem;
        //data[sheetName].Remove(deletedDataItem);

        await UpdateData.InvokeAsync();
    }
}