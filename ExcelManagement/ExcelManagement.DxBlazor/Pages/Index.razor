@using ExcelManagement.DxBlazor.Data
@using ExcelManagement.DxBlazor.Pages
@using ExcelManagement.ClassLibary
@using ExcelManagement.ClassLibary.Models

@using ClosedXML.Excel

@page "/"

@*Logo*@
<div style="width: 100%; height: auto; display: flex; justify-content: center;">
    <img src="/images/index.png" style="width: 50%" />
</div>
<p> </p>
<p> </p>


@*Loading Animation*@
@if (IsLoadingRender)
{
    <div class="text-center">
        <div class="spinner-border text-secondary" role="status">
            <span class="sr-only">Loading</span>
        </div>
        <h2>Loading...</h2>
    </div>
}
else
{
    if (!IsWorkbookSelected) //Select Sheet
    {
        <h3>Please select a excel document:</h3>
        <p></p>
        <DxComboBox Data="@Files"
            NullText="Select a File..."
            Value="@SelectedFileName"
            ValueChanged="(string fileName) => { SelectedFileName = fileName; IsWorkbookSelected = true; }">
        </DxComboBox>
    }

    else //If Sheet Has Been Selected
    {
        <WorkbookComponent SelectedFileName="@SelectedFileName"
            DirectoryPath="@DirectoryPath">
        </WorkbookComponent>
    }
}

@code {
    //Loading
    bool IsLoadingRender { get; set; } = true;
    bool IsWorkbookSelected { get; set; } = false;
    //Files
    private string SelectedFileName { get; set; }
    private string DirectoryPath { get; set; }
    private List<string> Files { get; set; } = new List<string>();

    //---------------------------------------------------------------------------//
    /* Razor Page                                                                */
    //---------------------------------------------------------------------------//

    protected override async Task OnInitializedAsync()
    {

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            DirectoryPath = @"..\ExcelDocuments"; //Default dirictory
            GetFiles(DirectoryPath);

            IsLoadingRender = false;
            StateHasChanged();
        }
    }

    //Get files in from dirictory.
    private void GetFiles(string directoryPath)
    {
        var fileNames = Directory.GetFiles(directoryPath, "*.xlsx");
        Files.AddRange(fileNames.Select(fileName => Path.GetFileNameWithoutExtension(fileName)));
    }
}